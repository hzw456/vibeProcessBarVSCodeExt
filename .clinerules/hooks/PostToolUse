#!/bin/bash
# Cline Hook: PostToolUse - 工具使用后更新进度

# 读取stdin的JSON输入
INPUT=$(cat)

# 提取任务信息
TASK_ID=$(echo "$INPUT" | jq -r '.taskId // "unknown"')
TOOL_NAME=$(echo "$INPUT" | jq -r '.postToolUse.toolName // "unknown"')
SUCCESS=$(echo "$INPUT" | jq -r '.postToolUse.success // true')

# 生成唯一的task_id
VIBE_TASK_ID="cline_${TASK_ID}"

# 根据工具类型更新进度
case "$TOOL_NAME" in
  "write_to_file"|"apply_diff")
    # 文件写入，增加token
    curl -s -X POST "http://localhost:31415/api/task/token" \
      -H "Content-Type: application/json" \
      -d "{\"task_id\": \"${VIBE_TASK_ID}\", \"tokens\": 100, \"increment\": true}" > /dev/null 2>&1
    ;;
  "execute_command")
    # 命令执行，更新进度
    curl -s -X POST "http://localhost:31415/api/task/progress" \
      -H "Content-Type: application/json" \
      -d "{\"task_id\": \"${VIBE_TASK_ID}\", \"progress\": 50}" > /dev/null 2>&1
    ;;
esac

# 如果工具执行失败，发送错误状态
if [ "$SUCCESS" = "false" ]; then
  curl -s -X POST "http://localhost:31415/api/task/error" \
    -H "Content-Type: application/json" \
    -d "{\"task_id\": \"${VIBE_TASK_ID}\", \"message\": \"Tool ${TOOL_NAME} failed\"}" > /dev/null 2>&1
fi

# 返回成功响应
echo '{"cancel": false}'
